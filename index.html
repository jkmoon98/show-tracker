<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShowTracker - Your TV Show Diary</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@600;700&family=Karla:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #14181c;
      --bg-secondary: #1c2128;
      --bg-card: #2c3440;
      --text-primary: #ffffff;
      --text-secondary: #9ab;
      --text-muted: #678;
      --accent-green: #00e054;
      --accent-green-hover: #00c248;
      --accent-orange: #ff8000;
      --border-color: #456;
      --rating-star: #00e054;
    }

    body {
      font-family: 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* Subtle film grain texture */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.03;
      z-index: 1;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    }

    /* Header styles */
    .app-header {
      position: relative;
      z-index: 2;
      padding: 40px 20px 32px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }

    .app-title {
      font-family: 'Crimson Pro', serif;
      font-size: clamp(42px, 6vw, 64px);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .app-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 20px;
      position: relative;
      z-index: 2;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 32px;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Karla', sans-serif;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-green);
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .filter-select {
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Karla', sans-serif;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent-green);
    }

    .btn-primary {
      padding: 12px 24px;
      background: var(--accent-green);
      border: none;
      border-radius: 4px;
      color: var(--bg-primary);
      font-size: 14px;
      font-weight: 700;
      font-family: 'Karla', sans-serif;
      cursor: pointer;
      transition: background 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary:hover {
      background: var(--accent-green-hover);
    }

    .btn-secondary {
      padding: 12px 24px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      font-family: 'Karla', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }

    /* View toggle */
    .view-toggle {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .view-toggle button {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 2px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      font-family: 'Karla', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .view-toggle button.active {
      background: var(--accent-green);
      color: var(--bg-primary);
    }

    /* Poster grid */
    .poster-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .poster-card {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .poster-card:hover {
      transform: translateY(-4px);
    }

    .poster-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 2/3;
      background: var(--bg-card);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .poster-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .poster-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 40%);
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 12px;
    }

    .poster-card:hover .poster-overlay {
      opacity: 1;
    }

    .poster-rating {
      display: flex;
      gap: 2px;
      margin-bottom: 4px;
    }

    .show-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-top: 8px;
      line-height: 1.3;
      text-align: center;
    }

    /* List view */
    .list-view {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 40px;
    }

    .list-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .list-item:hover {
      border-color: var(--accent-green);
      transform: translateX(4px);
    }

    .list-poster {
      width: 50px;
      height: 75px;
      background: var(--bg-card);
      border-radius: 2px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .list-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .list-info {
      flex: 1;
    }

    .list-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .list-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .list-rating {
      display: flex;
      gap: 3px;
    }

    /* Status badge */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-watching {
      background: var(--accent-green);
      color: var(--bg-primary);
    }

    .status-completed {
      background: var(--accent-orange);
      color: var(--bg-primary);
    }

    .status-planToWatch {
      background: #40bcf4;
      color: var(--bg-primary);
    }

    .status-dropped {
      background: #9ab;
      color: var(--bg-primary);
    }

    /* Stats section */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      padding: 32px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 40px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent-green);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 32px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-family: 'Crimson Pro', serif;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 24px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Karla', sans-serif;
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-green);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Star rating input */
    .star-rating-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .star-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      transition: transform 0.1s;
    }

    .star-btn:hover {
      transform: scale(1.15);
    }

    .star-icon {
      width: 24px;
      height: 24px;
    }

    .star-filled {
      fill: var(--rating-star);
      stroke: var(--rating-star);
    }

    .star-empty {
      fill: none;
      stroke: var(--text-muted);
    }

    /* Modal buttons */
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .modal-actions button {
      flex: 1;
    }

    /* TMDB search results */
    .tmdb-results {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .tmdb-result {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .tmdb-result:hover {
      border-color: var(--accent-green);
    }

    .tmdb-poster {
      width: 50px;
      height: 75px;
      background: var(--bg-card);
      border-radius: 2px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .tmdb-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tmdb-info {
      flex: 1;
    }

    .tmdb-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .tmdb-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }

    .empty-icon {
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
    }

    /* Footer */
    .app-footer {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-size: 12px;
      border-top: 1px solid var(--border-color);
    }

    .app-footer a {
      color: var(--accent-green);
      text-decoration: none;
      font-weight: 600;
    }

    .app-footer a:hover {
      text-decoration: underline;
    }

    /* Auth section */
    .auth-section {
      text-align: center;
      padding: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 32px;
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
      font-size: 16px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-title {
        font-size: 36px;
      }

      .toolbar {
        flex-direction: column;
      }

      .search-box {
        width: 100%;
      }

      .poster-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 16px;
      }

      .modal-content {
        padding: 24px;
      }

      .stats-section {
        padding: 24px;
      }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-card);
      border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Load config from config.js (copy config.example.js → config.js and fill in). config.js is gitignored. -->
  <script src="config.js"></script>
  <script>
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
      apiKey: '', authDomain: '', projectId: '', storageBucket: '', messagingSenderId: '', appId: ''
    };
    window.TMDB_API_KEY = window.TMDB_API_KEY || '';
  </script>
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = window.FIREBASE_CONFIG;
    let auth = null;
    let db = null;
    let firebaseEnabled = false;

    if (firebaseConfig && firebaseConfig.apiKey) {
      try {
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        firebaseEnabled = true;
      } catch (error) {
        console.error('Firebase initialization failed:', error);
      }
    }

    // ============================================
    // ICONS
    // ============================================

    const Star = ({ size = 24, filled = false }) => (
      <svg 
        className={`star-icon ${filled ? 'star-filled' : 'star-empty'}`}
        width={size} 
        height={size} 
        viewBox="0 0 24 24" 
        strokeWidth="2" 
        strokeLinecap="round" 
        strokeLinejoin="round"
      >
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
    );

    const Search = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    );

    const Film = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
        <line x1="7" y1="2" x2="7" y2="22"></line>
        <line x1="17" y1="2" x2="17" y2="22"></line>
        <line x1="2" y1="12" x2="22" y2="12"></line>
        <line x1="2" y1="7" x2="7" y2="7"></line>
        <line x1="2" y1="17" x2="7" y2="17"></line>
        <line x1="17" y1="17" x2="22" y2="17"></line>
        <line x1="17" y1="7" x2="22" y2="7"></line>
      </svg>
    );

    const Plus = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const X = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    // ============================================
    // TMDB API (client-side; key from config.js – works on free Spark plan)
    // ============================================
    const TMDB_API_KEY = window.TMDB_API_KEY;
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
    const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

    const searchTMDB = async (query) => {
      if (!query.trim() || !TMDB_API_KEY) return [];
      try {
        const response = await fetch(
          `${TMDB_BASE_URL}/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`
        );
        const data = await response.json();
        return data.results || [];
      } catch (error) {
        console.error('TMDB search error:', error);
        return [];
      }
    };

    const fetchTMDBDetails = async (tvId) => {
      if (!tvId || !TMDB_API_KEY) return null;
      try {
        const response = await fetch(
          `${TMDB_BASE_URL}/tv/${tvId}?api_key=${TMDB_API_KEY}`
        );
        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        console.error('TMDB details error:', error);
        return null;
      }
    };


    // ============================================
    // STATUS CONFIG
    // ============================================

    const statusConfig = {
      watching: { label: 'Watching', color: '#00e054', className: 'status-watching' },
      completed: { label: 'Completed', color: '#ff8000', className: 'status-completed' },
      planToWatch: { label: 'Plan to Watch', color: '#40bcf4', className: 'status-planToWatch' },
      dropped: { label: 'Dropped', color: '#9ab', className: 'status-dropped' }
    };

    // ============================================
    // MAIN APP
    // ============================================

    const TVShowTracker = () => {
      const [shows, setShows] = useState([]);
      const [user, setUser] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [searchQuery, setSearchQuery] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');
      const [viewMode, setViewMode] = useState('grid');
      const [sortOption, setSortOption] = useState('titleAsc');
      const [isAddingShow, setIsAddingShow] = useState(false);
      const [editingShow, setEditingShow] = useState(null);

      // Auth listener
      useEffect(() => {
        if (!firebaseEnabled) {
          setIsLoading(false);
          return;
        }

        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          if (user) {
            loadShows(user.uid);
          } else {
            setShows([]);
            setIsLoading(false);
          }
        });

        return () => unsubscribe();
      }, []);

      const loadShows = async (userId) => {
        setIsLoading(true);
        try {
          const userDoc = await db.collection('users').doc(userId).get();
          if (!userDoc.exists) {
            setShows([]);
            setIsLoading(false);
            return;
          }
          const data = userDoc.data() || {};
          const showsMap = data.shows || {};
          const loadedShows = Object.keys(showsMap).map(key => {
            const show = showsMap[key];
            let posterUrl = show.posterUrl || '';
            if (!posterUrl && show.posterPath) {
              posterUrl = `${TMDB_IMAGE_BASE}${show.posterPath}`;
            }
            return { id: key, ...show, posterUrl };
          });
          setShows(loadedShows);
        } catch (error) {
          console.error('Error loading shows:', error);
        } finally {
          setIsLoading(false);
        }
      };


      const signIn = async () => {
        if (!firebaseEnabled) return;
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (error) {
          console.error('Sign in error:', error);
        }
      };

      const signOut = async () => {
        if (!firebaseEnabled || !auth) return;
        try {
          await auth.signOut();
        } catch (error) {
          console.error('Sign out error:', error);
        }
      };

      const saveShow = async (showData) => {
        if (!user) return;

        try {
          const userRef = db.collection('users').doc(user.uid);
          const userDoc = await userRef.get();
          const data = userDoc.data() || {};
          const showsMap = data.shows || {};
          
          if (showData.id) {
            // Update existing show
            showsMap[showData.id] = {
              ...showData,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
          } else {
            // Create new show with numeric ID
            const nextId = Object.keys(showsMap).length;
            const { id, ...dataWithoutId } = showData;
            showsMap[nextId] = {
              ...dataWithoutId,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
          }
          
          // Save the updated shows map
          await userRef.set({
            shows: showsMap,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          
          await loadShows(user.uid);
          setIsAddingShow(false);
          setEditingShow(null);
        } catch (error) {
          console.error('Error saving show:', error);
        }
      };

      const deleteShow = async (showId) => {
        if (!user) return;
        if (!confirm('Delete this show?')) return;
        try {
          const userRef = db.collection('users').doc(user.uid);
          const updates = {
            [`shows.${showId}`]: firebase.firestore.FieldValue.delete(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          await userRef.update(updates);
          await loadShows(user.uid);
        } catch (error) {
          console.error('Error deleting show:', error);
        }
      };

      // Filtered + Sorted shows
      const filteredShows = useMemo(() => {
        const filtered = shows.filter(show => {
          const matchesSearch = (show.title || '').toLowerCase().includes(searchQuery.toLowerCase());
          const matchesStatus = statusFilter === 'all' || show.status === statusFilter;
          return matchesSearch && matchesStatus;
        });

        const sorted = [...filtered];
        const safeNum = (v) => (typeof v === 'number' && !Number.isNaN(v) ? v : null);

        sorted.sort((a, b) => {
          const at = (a.title || '').toLowerCase();
          const bt = (b.title || '').toLowerCase();
          const ar = safeNum(a.imdbRating);
          const br = safeNum(b.imdbRating);

          switch (sortOption) {
            case 'titleDesc':
              return bt.localeCompare(at);
            case 'imdbAsc': {
              // missing ratings go last
              if (ar === null && br === null) return at.localeCompare(bt);
              if (ar === null) return 1;
              if (br === null) return -1;
              return ar - br || at.localeCompare(bt);
            }
            case 'imdbDesc': {
              if (ar === null && br === null) return at.localeCompare(bt);
              if (ar === null) return 1;
              if (br === null) return -1;
              return br - ar || at.localeCompare(bt);
            }
            case 'titleAsc':
            default:
              return at.localeCompare(bt);
          }
        });

        return sorted;
      }, [shows, searchQuery, statusFilter, sortOption]);

      // Stats
      const stats = useMemo(() => {
        return {
          total: shows.length,
          watching: shows.filter(s => s.status === 'watching').length,
          completed: shows.filter(s => s.status === 'completed').length,
          planToWatch: shows.filter(s => s.status === 'planToWatch').length,
          dropped: shows.filter(s => s.status === 'dropped').length
        };
      }, [shows]);

      return (
        <div>
          {/* Header */}
          <header className="app-header">
            <h1 className="app-title">ShowTracker</h1>
            <p className="app-subtitle">Your personal TV show diary</p>
          </header>

          <div className="container">
            {/* Auth Section */}
            {firebaseEnabled ? (
              <div className="auth-section">
                {user ? (
                  <div className="user-info">
                    <span>Signed in as {user.email}</span>
                    <button className="btn-secondary" onClick={signOut}>Sign Out</button>
                  </div>
                ) : (
                  <div>
                    <p style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>
                      Sign in to sync your shows across devices
                    </p>
                    <button className="btn-primary" onClick={signIn}>Sign In with Google</button>
                  </div>
                )}
              </div>
            ) : (
              <div className="auth-section">
                <p style={{ color: 'var(--text-muted)', fontSize: '13px' }}>
                  Copy config.example.js to config.js and add your Firebase config to enable sync.
                </p>
              </div>
            )}

            {/* Toolbar */}
            <div className="toolbar">
              <div className="search-box">
                <Search className="search-icon" />
                <input
                  type="text"
                  className="search-input"
                  placeholder="Search shows..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>

              <select 
                className="filter-select"
                value={statusFilter}
                onChange={(e) => setStatusFilter(e.target.value)}
              >
                <option value="all">All Shows</option>
                {Object.entries(statusConfig).map(([key, config]) => (
                  <option key={key} value={key}>{config.label}</option>
                ))}
              </select>

              <select 
                className="filter-select"
                value={sortOption}
                onChange={(e) => setSortOption(e.target.value)}
              >
                <option value="titleAsc">Title (A–Z)</option>
                <option value="titleDesc">Title (Z–A)</option>
                <option value="imdbDesc">IMDb Rating (High → Low)</option>
                <option value="imdbAsc">IMDb Rating (Low → High)</option>
              </select>

              <div className="view-toggle">
                <button 
                  className={viewMode === 'grid' ? 'active' : ''}
                  onClick={() => setViewMode('grid')}
                >
                  Grid
                </button>
                <button 
                  className={viewMode === 'list' ? 'active' : ''}
                  onClick={() => setViewMode('list')}
                >
                  List
                </button>
              </div>

              <button 
                className="btn-primary" 
                onClick={() => setIsAddingShow(true)}
                disabled={!user}
              >
                <Plus size={16} /> Add Show
              </button>
            </div>

            {/* Content */}
            {isLoading ? (
              <div className="loading">Loading your shows...</div>
            ) : filteredShows.length === 0 ? (
              <div className="empty-state">
                <div className="empty-icon">
                  <Film size={64} />
                </div>
                <div className="empty-title">
                  {searchQuery ? 'No shows found' : 'No shows yet'}
                </div>
                <div className="empty-text">
                  {searchQuery ? 'Try a different search term' : 'Click "Add Show" to start tracking'}
                </div>
              </div>
            ) : viewMode === 'list' ? (
              <div className="list-view">
                {filteredShows.map(show => (
                  <div 
                    key={show.id} 
                    className="list-item"
                    onClick={() => setEditingShow(show)}
                  >
                    <div className="list-poster">
                      {show.posterUrl && (
                        <img src={show.posterUrl} alt={show.title} loading="lazy" />
                      )}
                    </div>
                    <div className="list-info">
                      <div className="list-title">{show.title}</div>
                      <div className="list-meta">
                        {show.year && <span>{show.year}</span>}
                        {show.seasons !== undefined && show.seasons !== '' && (
                          <>
                            {show.year && <span> • </span>}
                            <span>{show.seasons} season{Number(show.seasons) === 1 ? '' : 's'}</span>
                          </>
                        )}
                        {show.imdbRating ? (
                          <>
                            {(show.year || (show.seasons !== undefined && show.seasons !== '')) && <span> • </span>}
                            <span>IMDb {Number(show.imdbRating).toFixed(1)}</span>
                          </>
                        ) : null}
                        {(show.year || (show.seasons !== undefined && show.seasons !== '') || show.imdbRating) && <span> • </span>}
                        <span className={`status-badge ${statusConfig[show.status]?.className}`}>
                          {statusConfig[show.status]?.label}
                        </span>
                      </div>
                    </div>
                    {show.rating > 0 && (
                      <div className="list-rating">
                        {[...Array(5)].map((_, i) => (
                          <Star key={i} size={16} filled={i < show.rating} />
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <div className="poster-grid">
                {filteredShows.map(show => (
                  <div 
                    key={show.id}
                    className="poster-card"
                    onClick={() => setEditingShow(show)}
                  >
                    <div className="poster-wrapper">
                      {show.posterUrl ? (
                        <img 
                          src={show.posterUrl} 
                          alt={show.title} 
                          className="poster-img"
                          loading="lazy"
                        />
                      ) : (
                        <div style={{ 
                          width: '100%', 
                          height: '100%', 
                          display: 'flex', 
                          alignItems: 'center', 
                          justifyContent: 'center',
                          color: 'var(--text-muted)'
                        }}>
                          <Film size={48} />
                        </div>
                      )}
                      <div className="poster-overlay">
                        {show.rating > 0 && (
                          <div className="poster-rating">
                            {[...Array(5)].map((_, i) => (
                              <Star key={i} size={14} filled={i < show.rating} />
                            ))}
                          </div>
                        )}
                        <span className={`status-badge ${statusConfig[show.status]?.className}`}>
                          {statusConfig[show.status]?.label}
                        </span>
                      </div>
                    </div>
                    <div className="show-title">{show.title}</div>
                  </div>
                ))}
              </div>
            )}

            {/* Stats */}
            {shows.length > 0 && (
              <div className="stats-section">
                <div className="stat-item">
                  <div className="stat-number">{stats.total}</div>
                  <div className="stat-label">Total</div>
                </div>
                <div className="stat-item">
                  <div className="stat-number" style={{ color: statusConfig.watching.color }}>
                    {stats.watching}
                  </div>
                  <div className="stat-label">Watching</div>
                </div>
                <div className="stat-item">
                  <div className="stat-number" style={{ color: statusConfig.completed.color }}>
                    {stats.completed}
                  </div>
                  <div className="stat-label">Completed</div>
                </div>
                <div className="stat-item">
                  <div className="stat-number" style={{ color: statusConfig.planToWatch.color }}>
                    {stats.planToWatch}
                  </div>
                  <div className="stat-label">Plan to Watch</div>
                </div>
                <div className="stat-item">
                  <div className="stat-number" style={{ color: statusConfig.dropped.color }}>
                    {stats.dropped}
                  </div>
                  <div className="stat-label">Dropped</div>
                </div>
              </div>
            )}
          </div>

          {/* Footer */}
          <footer className="app-footer">
            <p>This product uses the TMDB API but is not endorsed or certified by TMDB.</p>
            <p>
              <a href="https://www.themoviedb.org/" target="_blank" rel="noopener noreferrer">
                Powered by The Movie Database (TMDB)
              </a>
            </p>
          </footer>

          {/* Modals */}
          {isAddingShow && (
            <FormModal
              onSave={saveShow}
              onClose={() => setIsAddingShow(false)}
            />
          )}

          {editingShow && (
            <FormModal
              show={editingShow}
              onSave={saveShow}
              onClose={() => setEditingShow(null)}
              onDelete={deleteShow}
            />
          )}
        </div>
      );
    };

    // ============================================
    // FORM MODAL
    // ============================================

    const FormModal = ({ show, onSave, onClose, onDelete }) => {
      const [tmdbQuery, setTmdbQuery] = useState('');
      const [tmdbResults, setTmdbResults] = useState([]);
      const [isSearching, setIsSearching] = useState(false);
      
      const [formData, setFormData] = useState({
        title: show?.title || '',
        year: show?.year || '',
        status: show?.status || 'planToWatch',
        rating: show?.rating || 0,
        notes: show?.notes || '',
        posterUrl: show?.posterUrl || '',
        tmdbId: show?.tmdbId || null,
        seasons: typeof show?.seasons === 'number' ? show.seasons : (show?.seasons || ''),
        imdbRating: typeof show?.imdbRating === 'number' ? show.imdbRating : 0
      });

      const searchTimeout = useRef(null);

      useEffect(() => {
        if (tmdbQuery.length <= 2) {
          setTmdbResults([]);
          return;
        }
        if (searchTimeout.current) clearTimeout(searchTimeout.current);
        searchTimeout.current = setTimeout(async () => {
          setIsSearching(true);
          const results = await searchTMDB(tmdbQuery);
          setTmdbResults(results);
          setIsSearching(false);
        }, 500);
        return () => {
          if (searchTimeout.current) clearTimeout(searchTimeout.current);
        };
      }, [tmdbQuery]);

      const selectTMDBShow = (result) => {
        setFormData({
          ...formData,
          title: result.name,
          year: result.first_air_date?.substring(0, 4) || '',
          posterUrl: result.poster_path ? `${TMDB_IMAGE_BASE}${result.poster_path}` : '',
          tmdbId: result.id
        });
        setTmdbResults([]);
        setTmdbQuery('');
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        
        if (!formData.title.trim()) {
          alert('Please enter a show title');
          return;
        }

        onSave({
          ...formData,
          id: show?.id || null
        });
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              {show ? 'Edit Show' : 'Add Show'}
            </div>

            <form onSubmit={handleSubmit}>
              {!show && (
                <div className="form-group">
                  <label className="form-label">Search TMDB</label>
                  <input
                    type="text"
                    className="form-input"
                    placeholder="Search for a TV show..."
                    value={tmdbQuery}
                    onChange={(e) => setTmdbQuery(e.target.value)}
                  />
                  
                  {isSearching && (
                    <div style={{ marginTop: '12px', color: 'var(--text-secondary)', fontSize: '14px' }}>
                      Searching...
                    </div>
                  )}
                  
                  {tmdbResults.length > 0 && (
                    <div className="tmdb-results">
                      {tmdbResults.slice(0, 5).map(result => (
                        <div
                          key={result.id}
                          className="tmdb-result"
                          onClick={() => selectTMDBShow(result)}
                        >
                          <div className="tmdb-poster">
                            {result.poster_path && (
                              <img 
                                src={`${TMDB_IMAGE_BASE}${result.poster_path}`} 
                                alt={result.name}
                              />
                            )}
                          </div>
                          <div className="tmdb-info">
                            <div className="tmdb-title">{result.name}</div>
                            <div className="tmdb-meta">
                              {result.first_air_date?.substring(0, 4)}
                              {result.overview && ` • ${result.overview.substring(0, 100)}...`}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              <div className="form-group">
                <label className="form-label">Title *</label>
                <input
                  type="text"
                  className="form-input"
                  value={formData.title}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  required
                />
              </div>

              <div className="form-group">
                <label className="form-label">Year</label>
                <input
                  type="text"
                  className="form-input"
                  placeholder="2024"
                  value={formData.year}
                  onChange={(e) => setFormData({ ...formData, year: e.target.value })}
                />
              </div>

              <div className="form-group">
                <label className="form-label">Seasons</label>
                <input
                  type="number"
                  min="0"
                  className="form-input"
                  placeholder="1"
                  value={formData.seasons}
                  onChange={(e) => setFormData({ ...formData, seasons: e.target.value === '' ? '' : Number(e.target.value) })}
                />
              </div>

              <div className="form-group">
                <label className="form-label">Status</label>
                <select
                  className="form-select"
                  value={formData.status}
                  onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                >
                  {Object.entries(statusConfig).map(([key, config]) => (
                    <option key={key} value={key}>{config.label}</option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label className="form-label">Rating</label>
                <div className="star-rating-input">
                  {[1, 2, 3, 4, 5].map((star) => (
                    <button
                      key={star}
                      type="button"
                      className="star-btn"
                      onClick={() => setFormData({ 
                        ...formData, 
                        rating: formData.rating === star ? 0 : star 
                      })}
                    >
                      <Star size={28} filled={star <= formData.rating} />
                    </button>
                  ))}
                </div>
              </div>

              <div className="form-group">
                <label className="form-label">Notes</label>
                <textarea
                  className="form-textarea"
                  placeholder="Your thoughts..."
                  value={formData.notes}
                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                />
              </div>

              <div className="modal-actions">
                <button type="button" className="btn-secondary" onClick={onClose}>
                  Cancel
                </button>
                {show && onDelete && (
                  <button 
                    type="button" 
                    className="btn-secondary" 
                    onClick={async () => {
                      await onDelete(show.id);
                      onClose();
                    }}
                    style={{ color: '#ef4444' }}
                  >
                    Delete
                  </button>
                )}
                <button type="submit" className="btn-primary">
                  {show ? 'Save Changes' : 'Add Show'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Render app
    ReactDOM.render(<TVShowTracker />, document.getElementById('root'));
  </script>
</body>
</html>
